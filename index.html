<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>February Book Club Nominations</title>

  <style>
    :root { --bg:#0b0c10; --card:#12131a; --muted:#9aa3b2; --text:#eef2ff; --border:#26293a; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,#0b0c10,#0b0c10 60%,#0e1020);
      color:var(--text);
    }
    .wrap{ max-width: 900px; margin: 0 auto; padding: 28px 16px 48px; }
    h1{ margin: 0 0 6px; font-size: 28px; }
    p{ margin: 8px 0; color: var(--muted); line-height: 1.45; }
    .card{
      background: rgba(18,19,26,.85);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    .list{ margin-top: 12px; padding: 0; list-style: none; }
    .item{
      display:flex; align-items:center; gap: 12px;
      background:#0f1020; border:1px solid var(--border);
      border-radius:14px; padding:12px; margin:10px 0;
      cursor:grab; user-select:none;
    }
    .item:active{ cursor:grabbing; }
    .rank{ width:28px; text-align:right; color:var(--muted); font-variant-numeric:tabular-nums; }
    .handle{
      width:32px; height:32px;
      border-radius:10px; border:1px solid var(--border);
      display:grid; place-items:center; color:var(--muted);
      flex:0 0 auto;
    }

    .rankWrap{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }

    .rankInput{
      width:64px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#0f1020;
      color:var(--text);
      outline:none;
      font-variant-numeric: tabular-nums;
    }

    .rankInput:focus{
      border-color:#6366f1;
    }

    /* Hide number input spinners (Chrome/Edge/Safari) */
    .rankInput::-webkit-outer-spin-button,
    .rankInput::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Hide number input spinners (Firefox) */
    .rankInput[type="number"] {
      -moz-appearance: textfield;
    }

    /* Mobile-safe wrapping in flex layout */
    .title{ flex:1; min-width:0; }
    .title strong{ display:block; font-size:15px; font-weight:650; overflow-wrap:anywhere; }
    .title span{ display:block; font-size:13px; color:var(--muted); margin-top:2px; overflow-wrap:anywhere; }

    .links{
      margin-top: 8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-block;
      font-size:12px;
      color:#a5b4fc;
      text-decoration:none;
      border:1px solid var(--border);
      background:#14152a;
      padding:6px 10px;
      border-radius:999px;
      max-width:100%;
      white-space:normal;
      overflow-wrap:anywhere;
      -webkit-tap-highlight-color: transparent;
    }
    .chip:hover{ text-decoration: underline; }

    .ghost{ opacity:.55; }

    .actions{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:1px solid var(--border);
      background:#15162a; color:var(--text);
      padding:10px 14px; border-radius:12px;
      cursor:pointer; font-weight:600;
    }
    button.primary{
      background:linear-gradient(135deg,#7c3aed,#6366f1);
      border-color:#7c3aed;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .status{ margin-top:12px; font-size:13px; color:var(--muted); }
    pre{
      display:none; margin-top:12px;
      background:#0f1020; border:1px solid var(--border);
      border-radius:12px; padding:12px;
      overflow:auto; font-size:12px;
    }

    @media (max-width: 520px){
      .item{ padding: 12px 10px; }
      .handle{ width: 34px; height: 34px; }
      .chip{ padding: 7px 12px; }
    }

    /* Hide the copy button from users (but keep it in the DOM) */
    #copyBtn { display: none; }

    /* “Submitted!” banner */
    .submitted{
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: #0f1020;
      border-radius: 12px;
      font-weight: 700;
    }

    #output {
      display: none !important;
    }

  </style>
</head>

<body>
<div class="wrap">
  <h1>February Book Club Nominations</h1>
  <p>Drag books from <strong>most interested</strong> (top) to <strong>least interested</strong> (bottom), then click Submit.</p>

  <div class="card">
    <label for="nameInput" style="display:block; margin-top:6px; color: var(--muted); font-size:13px;">Your name (optional)</label>
    <input
      id="nameInput"
      type="text"
      placeholder="e.g., Christina"
      autocomplete="name"
      style="
        width:100%;
        margin-top:6px;
        padding:10px 12px;
        border-radius:12px;
        border:1px solid var(--border);
        background:#0f1020;
        color:var(--text);
        outline:none;
      "
    />

    <ol id="rankList" class="list">

      <!-- 1. American Dirt -->
      <li class="item" draggable="true" data-id="american-dirt">
        <div class="rankWrap">
          <div class="rank">1</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>American Dirt</strong><span>Jeanine Cummins</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/45046527-american-dirt" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2020/01/19/books/review/american-dirt-jeanine-cummins.html" target="_blank" rel="noopener noreferrer">NYT</a>
            <a class="chip" href="https://a.co/d/6x8cZTP" target="_blank" rel="noopener noreferrer">Amazon</a>
          </div>
        </div>
      </li>

      <!-- 2. Beautiful Ugly -->
      <li class="item" draggable="true" data-id="beautiful-ugly">
        <div class="rankWrap">
          <div class="rank">2</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Beautiful Ugly</strong><span>Alice Feeney</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/211004123-beautiful-ugly" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 3. Bury Our Bones in the Midnight Soil -->
      <li class="item" draggable="true" data-id="bury-our-bones-in-the-midnight-soil">
        <div class="rankWrap">
          <div class="rank">3</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Bury Our Bones in the Midnight Soil</strong><span>V. E. Schwab</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/215020997-bury-our-bones-in-the-midnight-soil" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2025/06/10/books/review/bury-our-bones-in-the-midnight-soil-by-v-e-schwab.html" target="_blank" rel="noopener noreferrer">NYT</a>
          </div>
        </div>
      </li>

      <!-- Caucasia -->
      <li class="item" draggable="true" data-id="caucasia">
        <div class="rankWrap">
          <div class="rank">4</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Caucasia</strong><span>Danzy Senna</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/33795.Caucasia" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 4. Cutting for Stone -->
      <li class="item" draggable="true" data-id="cutting-for-stone">
        <div class="rankWrap">
          <div class="rank">5</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Cutting for Stone</strong><span>Abraham Verghese</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/3591262" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2009/02/08/books/review/Wagner-t.html" target="_blank" rel="noopener noreferrer">NYT</a>
          </div>
        </div>
      </li>

      <!-- 5. The Eyes of Gaza -->
      <li class="item" draggable="true" data-id="eyes-of-gaza">
        <div class="rankWrap">
          <div class="rank">6</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>The Eyes of Gaza</strong><span>Plestia Alaqad</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/219223024" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 6. The God Of The Woods -->
      <li class="item" draggable="true" data-id="god-of-the-woods">
        <div class="rankWrap">
          <div class="rank">7</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>The God Of The Woods</strong><span>Liz Moore</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/199698485-the-god-of-the-woods" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2024/07/02/books/review/the-god-of-the-woods-liz-moore.html" target="_blank" rel="noopener noreferrer">NYT</a>
          </div>
        </div>
      </li>

      <!-- Happy Wife -->
      <li class="item" draggable="true" data-id="happy-wife">
        <div class="rankWrap">
          <div class="rank">8</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Happy Wife</strong><span>Meredith Lavender & Kendall Shores</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/217927640-happy-wife" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- Homeseeking -->
      <li class="item" draggable="true" data-id="homeseeking">
        <div class="rankWrap">
          <div class="rank">9</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Homeseeking</strong><span>Karissa Chen</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/211025407-homeseeking" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- Horse -->
      <li class="item" draggable="true" data-id="horse">
        <div class="rankWrap">
          <div class="rank">10</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Horse</strong><span>Geraldine Brooks</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/59109077-horse" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 7. How to Dodge a Cannonball -->
      <li class="item" draggable="true" data-id="how-to-dodge-a-cannonball">
        <div class="rankWrap">
          <div class="rank">11</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>How to Dodge a Cannonball</strong><span>Dennard Dayle</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/217388187-how-to-dodge-a-cannonball" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2025/06/16/books/review/how-to-dodge-a-cannonball-dennard-dayle.html" target="_blank" rel="noopener noreferrer">NYT</a>
          </div>
        </div>
      </li>

      <!-- 8. How to Say Babylon -->
      <li class="item" draggable="true" data-id="how-to-say-babylon">
        <div class="rankWrap">
          <div class="rank">12</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>How to Say Babylon</strong><span>Safiya Sinclair</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/62919742-how-to-say-babylon" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2023/09/29/books/review/how-to-say-babylon-safiya-sinclair.html" target="_blank" rel="noopener noreferrer">NYT</a>
          </div>
        </div>
      </li>

      <!-- 9. I Who Have Never Known Men -->
      <li class="item" draggable="true" data-id="i-who-have-never-known-men">
        <div class="rankWrap">
          <div class="rank">13</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>I Who Have Never Known Men</strong><span>Jacqueline Harpman</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/60811826" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 10. Isola -->
      <li class="item" draggable="true" data-id="isola">
        <div class="rankWrap">
          <div class="rank">14</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Isola</strong><span>Allegra Goodman</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/212806636-isola" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2025/02/01/books/review/allegra-goodman-isola.html" target="_blank" rel="noopener noreferrer">NYT</a>
          </div>
        </div>
      </li>

      <!-- 11. The Mad Wife -->
      <li class="item" draggable="true" data-id="mad-wife">
        <div class="rankWrap">
          <div class="rank">15</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>The Mad Wife</strong><span>Meagan Church</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/223665360-the-mad-wife" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 12. North Woods -->
      <li class="item" draggable="true" data-id="north-woods">
        <div class="rankWrap">
          <div class="rank">16</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>North Woods</strong><span>Daniel Mason</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/75569082" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2023/09/19/books/review/daniel-mason-north-woods.html" target="_blank" rel="noopener noreferrer">NYT</a>
          </div>
        </div>
      </li>

      <!-- Pineapple Street -->
      <li class="item" draggable="true" data-id="pineapple-street">
        <div class="rankWrap">
          <div class="rank">17</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Pineapple Street</strong><span>Jenny Jackson</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/61246258-pineapple-street" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 13. Run for the Hills -->
      <li class="item" draggable="true" data-id="run-for-the-hills">
        <div class="rankWrap">
          <div class="rank">18</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Run for the Hills</strong><span>Kevin Wilson</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/218671843-run-for-the-hills" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2025/05/13/books/review/kevin-wilson-run-for-the-hills.html" target="_blank" rel="noopener noreferrer">NYT</a>
          </div>
        </div>
      </li>

      <!-- 14. Stone Yard Devotional -->
      <li class="item" draggable="true" data-id="stone-yard-devotional">
        <div class="rankWrap">
          <div class="rank">19</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Stone Yard Devotional</strong><span>Charlotte Wood</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/168632462-stone-yard-devotional" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2025/02/10/books/review/stone-yard-devotional-charlotte-wood.html?smid=nytcore-android-share" target="_blank" rel="noopener noreferrer">NYT</a>
          </div>
        </div>
      </li>

      <!-- 15. The Sun Does Shine -->
      <li class="item" draggable="true" data-id="sun-does-shine">
        <div class="rankWrap">
          <div class="rank">20</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>The Sun Does Shine</strong><span>Anthony Ray Hinton</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/34964905-the-sun-does-shine" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 16. Theo of Golden -->
      <li class="item" draggable="true" data-id="theo-of-golden">
        <div class="rankWrap">
          <div class="rank">21</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Theo of Golden</strong><span>Allen Levi</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/242376245-theo-of-golden" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 17. Twenty Years Later -->
      <li class="item" draggable="true" data-id="twenty-years-later">
        <div class="rankWrap">
          <div class="rank">22</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Twenty Years Later</strong><span>Charlie Donlea</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/57645345-twenty-years-later" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

      <!-- 18. Victorian Psycho -->
      <li class="item" draggable="true" data-id="victorian-psycho">
        <div class="rankWrap">
          <div class="rank">23</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Victorian Psycho</strong><span>Virginia Feito</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/213395480-victorian-psycho" target="_blank" rel="noopener noreferrer">Goodreads</a>
            <a class="chip" href="https://www.nytimes.com/2025/02/01/books/review/victorian-psycho-virginia-feito.html" target="_blank" rel="noopener noreferrer">NYT</a>
            <a class="chip" href="https://a.co/d/013pHNL" target="_blank" rel="noopener noreferrer">Amazon</a>
          </div>
        </div>
      </li>

      <!-- Wellness -->
      <li class="item" draggable="true" data-id="wellness">
        <div class="rankWrap">
          <div class="rank">24</div>
          <input class="rankInput" type="number" min="1" step="1" inputmode="numeric" aria-label="Set rank" />
        </div>
        <div class="handle">≡</div>
        <div class="title">
          <strong>Wellness</strong><span>Nathan Hill</span>
          <div class="links">
            <a class="chip" href="https://www.goodreads.com/book/show/65650229-wellness" target="_blank" rel="noopener noreferrer">Goodreads</a>
          </div>
        </div>
      </li>

    </ol>

    <div class="actions">
  <button class="primary" id="submitBtn">Submit</button>

  <!-- Hidden admin/debug button (kept so JS doesn't break) -->
  <button id="copyBtn" disabled>Copy submission JSON</button>

  <button id="resetBtn">Reset order</button>
  </div>

  <!-- Submitted confirmation banner -->
  <div id="submittedBanner" class="submitted" hidden>Submitted!</div>

  <div class="status" id="status">Not submitted yet.</div>
  <pre id="output"></pre>

  </div>
</div>

<script>
(() => {
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZDqYAhC_FOVQA-oC-J1XnvbA3h3xvB5GV5cQ4RXkzGcvPjTo8Obb-WnDAAr2EPW8_hA/exec';
  const list = document.getElementById('rankList');
  const statusEl = document.getElementById('status');
  const outEl = document.getElementById('output');
  const submitBtn = document.getElementById('submitBtn');
  const copyBtn = document.getElementById('copyBtn'); // now exists if you add the button
  const resetBtn = document.getElementById('resetBtn');
  const submittedBanner = document.getElementById('submittedBanner');
  const nameInput = document.getElementById('nameInput');

  const STORAGE_KEY = 'bookclub_ranking_final_google_sheet_v1';
  let dragSrc = null;
  const originalOrder = Array.from(list.children);

  function items(){ return Array.from(list.children); }

  function updateRanks(){
    items().forEach((li, i) => li.querySelector('.rank').textContent = i + 1);
    syncRankInputs();
  }

  function clamp(n, min, max){
    return Math.max(min, Math.min(max, n));
  } 

  function moveItemToRank(li, targetRank){
    const all = items();
    const maxRank = all.length;

    const parsed = parseInt(targetRank, 10);
    if (!Number.isFinite(parsed)) {
      updateRanks(); // revert input to current rank
      return;
    }

    const r = clamp(parsed, 1, maxRank);
    const targetIndex = r - 1;

    const currentIndex = all.indexOf(li);
    if (currentIndex === -1 || currentIndex === targetIndex) {
      updateRanks();
      return;
    }

    // IMPORTANT: if moving DOWN, insert before the node AFTER the target,
    // because removing `li` shifts indices left.
    let beforeNode = null;
    if (currentIndex < targetIndex) {
      beforeNode = all[targetIndex + 1] || null; // null => append to end
    } else {
      beforeNode = all[targetIndex] || null;
    }

    list.insertBefore(li, beforeNode);
    updateRanks();
  }

  function syncRankInputs(){
    items().forEach((li, i) => {
      const inp = li.querySelector('.rankInput');
      if (inp) {
        inp.value = String(i + 1);
        inp.max = String(items().length);
      }
    });
  }

  function linkByLabel(li, label) {
    const anchors = Array.from(li.querySelectorAll('.links a'));
    return anchors.find(a => a.textContent.trim() === label)?.href || null;
  }

  function getClientId() {
    const KEY = 'bookclub_client_id';
    let id = localStorage.getItem(KEY);
    if (!id) {
      id = crypto.randomUUID();
      localStorage.setItem(KEY, id);
    }
    return id;
  }

  function serialize() {
    const name = (nameInput?.value || '').trim();

    return {
      submitted_at: new Date().toISOString(),
      client_id: getClientId(),
      name: name.length ? name : null,   // optional
      ranking: Array.from(list.children).map((li, i) => ({
        rank: i + 1,
        title: li.querySelector('strong').textContent
      }))
    };
  }


  function wire(li){
    // existing drag handlers...
    li.addEventListener('dragstart', e => {
      dragSrc = li;
      li.classList.add('ghost');
      e.dataTransfer.setData('text/plain', li.dataset.id);
      e.dataTransfer.effectAllowed = 'move';
    });

    li.addEventListener('dragend', () => {
      li.classList.remove('ghost');
      dragSrc = null;
      updateRanks();
    });

    li.addEventListener('dragover', e => {
      e.preventDefault();
      if (!dragSrc || dragSrc === li) return;
      const rect = li.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height / 2;
      list.insertBefore(dragSrc, before ? li : li.nextSibling);
    });

    // NEW: keypad rank change
    const rankInput = li.querySelector('.rankInput');
    if (rankInput) {
      // Prevent dragging when interacting with the input
      rankInput.addEventListener('mousedown', e => e.stopPropagation());
      rankInput.addEventListener('touchstart', e => e.stopPropagation(), { passive: true });

      rankInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          moveItemToRank(li, rankInput.value);
          rankInput.blur();
        }
      });

      rankInput.addEventListener('blur', () => {
        // Move on blur as well (covers mobile keypad "Done")
        moveItemToRank(li, rankInput.value);
      });
    }
  }

  async function submitToGoogleSheet(payload) {
    const res = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'cors', // <-- change from "no-cors"
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload),
      cache: 'no-store',
    });

    if (!res.ok) {
      const text = await res.text().catch(() => '');
      throw new Error(`HTTP ${res.status} ${res.statusText} ${text}`.trim());
    }

    // Expect JSON back from Apps Script
    const data = await res.json().catch(async () => ({ raw: await res.text() }));
    if (data && data.ok === false) {
      throw new Error(data.error || 'Server reported failure');
    }
    return data;
  }

  // Attach drag listeners
  items().forEach(wire);
  updateRanks();

  submitBtn.onclick = async () => {
    submitBtn.disabled = true;
    statusEl.textContent = 'Submitting...';
    submittedBanner.hidden = true;

    try {
      const payload = serialize();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));

      const resp = await submitToGoogleSheet(payload);

      statusEl.textContent = 'Submitted!';
      submittedBanner.hidden = false;
    } catch (err) {
      submittedBanner.hidden = true;
      statusEl.textContent = `Submission failed: ${String(err)}`;
    } finally {
      submitBtn.disabled = false;
    }
  };

  if (copyBtn) {
    copyBtn.onclick = async () => {
      await navigator.clipboard.writeText(outEl.textContent || '');
      statusEl.textContent = 'Submission copied to clipboard.';
    };
  }

  resetBtn.onclick = () => {
    originalOrder.forEach(li => list.appendChild(li));
    updateRanks();
    statusEl.textContent = 'Order reset.';
  };
})();
</script>

</body>
</html>
